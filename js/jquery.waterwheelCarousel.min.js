/*
 * Waterwheel Carousel
 * Version 1.3
 * http://www.bkosborne.com
 *
 * Copyright 2011 Brian Osborne
 * Licensed under GPL version 3
 * http://www.gnu.org/licenses/gpl.txt
 * 
 * Plugin written by Brian Osborne
 * for use with the jQuery JavaScript Framework
 * http://www.jquery.com
 *
 */
(function(a){a.fn.waterwheelCarousel=function(b){b=a.extend({},a.fn.waterwheelCarousel.defaults,b||{});return a(this).each(function(){function d(a){clearTimeout(c.autoPlayTimer);if(!a&&b.autoPlay!==0){c.autoPlayTimer=setTimeout(function(){if(b.autoPlay>0){r(false)}else{r(true)}},Math.abs(b.autoPlay))}}function e(a){var b=a===1?null:a-1;return b}function f(a){var b=a===c.totalItems?null:a+1;return b}function g(){c.itemsContainer.find("img").hide()}function h(b){var d=c.itemsContainer.find("img"),e=0,f=d.length;d.each(function(){a(this).load(function(){e+=1;if(e===f){b()}});if(this.complete||a.browser.msie){a(this).trigger("load")}})}function i(){c.itemDistances[0]=b.startingItemSeparation;c.waveDistances[0]=b.startingWaveSeparation;c.itemFactor[0]=1;c.itemOpacities[0]=1*b.opacityDecreaseFactor;c.itemsContainer.find("img").each(function(b,d){d=a(d);var e=d.width();var f=d.height();c.itemWidths[d.attr("src")]=e;c.itemHeights[d.attr("src")]=f});var d;for(d=1;d<b.flankingItems+1;d++){c.itemDistances[d]=c.itemDistances[d-1]*b.itemSeparationFactor;c.waveDistances[d]=c.waveDistances[d-1]*b.waveSeparationFactor;c.itemFactor[d]=c.itemFactor[d-1]*b.itemDecreaseFactor;c.itemOpacities[d]=c.itemOpacities[d-1]*b.opacityDecreaseFactor;if(d===b.flankingItems){c.itemFactor[d+1]=c.itemFactor[d]*b.itemDecreaseFactor}}c.itemOpacities[c.itemOpacities.length-1]=0;console.log("---")}function j(){c.items=c.itemsContainer.find("img");var d;for(d=0;d<c.items.length;d++){c.items[d]=a(c.items[d])}c.itemsContainer.css("position","relative").find("img").each(function(d){var e,f;if(b.orientation==="horizontal"){e=c.containerWidth/2-a(this).width()/2;f=b.centerOffset}else{e=b.centerOffset;f=c.containerHeight/2-a(this).height()/2}a(this).css({left:e,top:f,visibility:"visible",position:"absolute","z-index":b.flankingItems+2,opacity:1}).data({currentPosition:0,oldPosition:0,width:a(this).width(),owidth:a(this).width(),height:a(this).height(),oheight:a(this).height(),top:f,left:e,opacity:1,index:d}).show()})}function k(){b.startingItem=b.startingItem===0?Math.round(c.totalItems/2):b.startingItem;c.carouselRotationsLeft=1;c.items[b.startingItem-1].addClass(b.activeClassName);b.movedToCenter(c.items[b.startingItem-1]);c.currentCenterItem=c.items[b.startingItem-1];var a,d,e;a=1;for(d=b.startingItem-2;d>=0;d--){for(e=0;e<a;e++){m(c.items[d],false)}a++}a=1;for(d=b.startingItem;d<c.items.length;d++){for(e=0;e<a;e++){m(c.items[d],true)}a++}}function l(a,d){var e=a.data().currentPosition;var f=Math.abs(d);var g=c.itemFactor[f]*c.itemWidths[a];var h=c.itemFactor[f]*c.itemHeights[a];var g=c.itemWidths[a.attr("src")];var h=c.itemHeights[a.attr("src")];console.log(a.get(0));console.log(g);var i=Math.abs(a.data().width-g);var j=Math.abs(a.data().height-h);var k=0,l;if(b.orientation==="horizontal"){l=j/2}else{l=i/2}if(d>-1&&d<e||d<1&&d>e){k-=l;k+=c.waveDistances[Math.abs(d)]}else if(d>-1&&d>e||d<1&&d<e){k+=l;k-=c.waveDistances[Math.abs(d)-1]}var m=0;if(Math.abs(d)<Math.abs(e)){m=c.itemDistances[Math.abs(d)]}else{m=c.itemDistances[Math.abs(d)-1]}if(d>0||d===0&&e===1){if(b.orientation==="horizontal"){m+=i}else{m+=j}}if(d<e){m=m*-1}var n;if(d===0){n=1}else{n=c.itemOpacities[Math.abs(d)-1]}var o=a.data().top;var p=a.data().left;if(b.orientation==="horizontal"){o=a.data().top+k;p=a.data().left+m}else{o=a.data().top+m;p=a.data().left+k}var q=b.flankingItems+2-f;a.data("width",g);a.data("height",h);a.data("top",o);a.data("left",p);a.data("oldPosition",e);a.data("currentPosition",d);a.data("depth",q);a.data("opacity",n)}function m(a,d){var e=a.data("currentPosition"),f;if(d===false){f=e-1}else{f=e+1}if(Math.abs(f)<=b.flankingItems+1){c.itemsAnimating++;l(a,f);if(f===0){b.movingToCenter(a)}if(e===0){b.movingFromCenter(a);a.removeClass(b.activeClassName)}a.css("z-index",a.data().depth);a.animate({left:a.data().left,width:a.data().width,height:a.data().height,top:a.data().top,opacity:a.data().opacity},c.currentSpeed,b.animationEasing,function(){n(a,f,d)})}else if(Math.abs(f)>b.flankingItems){a.data("oldPosition",e);a.data("currentPosition",f)}}function n(a,e,f){if(e===0){c.currentCenterItem=a;a.addClass(b.activeClassName)}if(a.data().oldPosition===0){b.movedFromCenter(a)}c.itemsAnimating--;if(c.itemsAnimating===0){c.carouselRotationsLeft-=1;c.currentlyMoving=false;if(c.carouselRotationsLeft>0){q(f,0)}else{c.currentSpeed=b.speed;if(c.currentCenterItem!==null){b.movedToCenter(c.currentCenterItem)}d()}}}function o(){var a;for(a=0;a<c.items.length;a++){c.items[a].stop()}}function p(a){if(c.currentlyMoving===true){return false}if(a===true&&c.items[0].data().currentPosition===0){return false}if(a===false&&c.items[c.totalItems-1].data().currentPosition===0){return false}return true}function q(d,e){if(p(d)){c.currentlyMoving=true;c.itemsAnimating=0;c.carouselRotationsLeft+=e;if(b.quickerForFurther===true){if(e>1){c.currentSpeed=b.speed/e}c.currentSpeed=c.currentSpeed<100?100:c.currentSpeed}else{c.currentSpeed=b.speed}var f;for(f=0;f<c.items.length;f++){var g=a(c.items[f]);var h=g.data().currentPosition;if(h>=b.flankingItems*-1-1&&h<=b.flankingItems+1){m(g,d)}else{g.data("oldPosition",h);if(d===true){g.data("currentPosition",h+1)}else{g.data("currentPosition",h-1)}}}}}function r(a){var d=c.currentCenterItem.data().index;if(d===0&&a===true||d===c.totalItems-1&&a===false){clearTimeout(c.autoPlayTimer);if(b.edgeReaction==="reset"){q(!a,c.totalItems-1)}else if(b.edgeReaction==="reverse"&&b.autoPlay!==0){q(!a,1);b.autoPlay*=-1}}else{q(a,1)}}var c={itemsContainer:a(this).find(".carousel-images"),totalItems:a(this).find(".carousel-images img").length,containerWidth:a(this).width(),containerHeight:a(this).height(),currentCenterItem:null,items:[],itemDistances:[],waveDistances:[],itemFactor:[],itemWidths:{},itemHeights:{},itemOpacities:[],carouselRotationsLeft:0,currentlyMoving:false,itemsAnimating:0,currentSpeed:b.speed,intervalTimer:null};g();h(function(){i();j();k()});a(this).find(".carousel-images img").live("click",function(){d(true);b.autoPlay=0;var c=a(this).data().currentPosition;var e=Math.abs(c);if(c<0){q(true,e)}else if(c>0){q(false,e)}else{b.clickedCenter(a(this))}});a(this).find(".carousel-images a").live("click",function(c){var d=a(this).find("img").width()===a(this).find("img").data().owidth?true:false;if(b.linkHandling===1||b.linkHandling===2&&!d){c.preventDefault();return false}});a(this).find(".carousel-controls .carousel-prev").live("click",function(a){r(true);a.preventDefault();return false});a(this).find(".carousel-controls .carousel-next").live("click",function(a){r(false);a.preventDefault();return false});if(b.keyboardNav){a(document).keydown(function(a){if(a.which===37||a.which===38){r(true)}else if(a.which===39||a.which===40){r(false)}if(b.keyboardNavOverride&&(a.which===37||a.which===38||a.which===39||a.which===40)){a.preventDefault();return false}})}})};a.fn.waterwheelCarousel.defaults={startingItem:0,startingItemSeparation:150,itemSeparationFactor:.5,startingWaveSeparation:30,waveSeparationFactor:.75,itemDecreaseFactor:.8,opacityDecreaseFactor:.5,centerOffset:40,flankingItems:4,speed:300,animationEasing:"linear",quickerForFurther:true,linkHandling:2,autoPlay:0,orientation:"horizontal",activeClassName:"active",keyboardNav:false,keyboardNavOverride:true,edgeReaction:"reset",movingToCenter:a.noop,movedToCenter:a.noop,clickedCenter:a.noop,movingFromCenter:a.noop,movedFromCenter:a.noop}})(jQuery)
